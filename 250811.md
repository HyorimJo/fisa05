# 8/11 ELK 4일차

## Keywords
agg cardinality from/to histogram interval

***

## Keeps
from to 쓸까 gte 쓸까

## Problem
depth 헷갈리지 말기 괄호 꼭꼭 닫기

## Try
교재를 한 번 더 읽어봐야 겠다


## 알아둘 내용

## 실습 1

### 1) bank의 모든 고객수는 몇 명인가요? - 43475
```
GET bank/_search
{
  "size" : 0,
  "query": {
    "match_all": {}
  },
  "aggs": { // 집계 결과만 출력
    "고객수 총합": {
      "sum": {
        "field": "customers"
      }
    }
  }
}
```

### 2) bank들 중에서 최소 고객을 보유한 은행의 고객 수는  몇 명인가요? 은행은 어디인지도 같이 적어주세요. - 100명, 18/기업은행/2호점/불광
```
GET bank/_search
{
  "size" : 0,
  "query": {
    "match_all": {}
  },
  "aggs": { // 집계 결과만 출력
    "my-min-aggregation": {
      "min": {
        "field": "customers"
      }
    }
  }
}

GET bank/_search
{
  "query": {
    "match": {
      "customers" : 100
    }
  }
}

// sql의 order by처럼 order라는 파라미터로 원하는 기준으로 전체 문서를 정렬하는 것은 가능합니다.
GET bank/_search
{
  "size" : 1,
  "sort" : [
    {
      "customers" : {
        "order" : "asc"
      }
    }
  ]
}
```

### 3) 불광지역에 있는 모든 은행들을 검색해보세요.
```
GET bank/_search
{
  "query": {
    "match": {
      "location" : "불광"
    }
  }
}
```

### 4) 불광지역에 있는 모든 은행 고객수를 합하면 몇 명인가요? - 8243
```
GET bank/_search
{
  "size" : 0,
  "query": {
    "match": {
      "location" : "불광"
    }
  },
  "aggs": {
    "my-sum-aggregation": {
      "sum": {
        "field": "customers"
      }
    }
  }
}
```

## 실습 2
```
GET bank/_mapping
GET bank/_search
{
  "size" : 1
}
```

### 1. customers 수가 100명 이상 152명 미만인 구간의 문서를 검색해보세요.
```
GET bank/_search
{
  "aggs" : {
    "문서" : {
      "range": {
        "field": "customers",
        "ranges": [
          {"from" : 100,
          "to" : 152}
        ]
      }
    }
  }
}

GET bank/_search
{
  "query": {
    "range": {
      "customers": {
        "gte": 100,
        "lt": 152
      }
    }
  }
}
```

### 2. 500명 단위로 구간을 나누어서 숫자 범위로 문서를 검색해보세요.
```
GET bank/_search
{
  "size": 0,
  "aggs": {
    "customer_ranges": {
      "range": {
        "field": "customers",
        "ranges": [
          { "to": 500 },
          { "from": 500, "to": 1000 },
          { "from": 1000, "to": 1500 },
          { "from": 1500 }
        ]
      }
    }
  }
}

GET bank/_search
{
  "size" : 0,
  "aggs" : {
    "my-histogram" : {
      "histogram": {
        "field": "customers",
        "interval" : 500
      }
    }
  }
}
```

### 3. 월별로 구간을 나누어 검색해보세요.
```
GET bank/_search
{
  "size" : 0,
  "aggs" : {
    "my-date-histogram" : {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month",
        "format": "yyyy-MM",
        "min_doc_count" : 1
      }
    }
  }
}
```

### 4. 년도별로 구간을 나누어 검색해보세요.
```
GET bank/_search
{
  "size" : 0,
  "aggs" : {
    "my-date-histogram" : {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "year",
        "format": "yyyy",
        "min_doc_count" : 1
      }
    }
  }
}
```

### 5. 각 지역에 은행이 몇 개씩 있는지, 위치 키워드 문자열 별로 버킷을 나누어 집계해보세요.
```
GET bank/_search
{
  "size" : 0,
  "aggs" : {
    "지역별 은행": {
      "terms" : {
        "field": "location.keyword"
      }
    }
  }
}
```

### 6. 각 은행별로 개점년도로 집계 후 고객 수를 하위 집계를 수행해보세요.
```
GET bank/_search
{
  "size": 0,
  "aggs": {
    "banks": {
      "terms": {
        "field": "bank.keyword"
      },
      "aggs": {
        "customers_per_year": {
          "date_histogram": {
            "field": "date",
            "calendar_interval": "year",
            "format": "yyyy",
            "min_doc_count" : 1
          },
          "aggs": {
            "total_customers": {
              "sum": {
                "field": "customers"
              }
            }
          }
        }
      }
    }
  }
}
```